# RSA Returns
Cryptography - 400 points

## Challenge 
> Written by neptunia

> It's the return of everyone's favorite cryptosystem! Crack it for another flag. Help me decipher.

> [file](hardrsa.txt).

## Hint
> lolno

## Solution (Incomplete)

As the name and the points imply, this might be one of those new vulnerabilities such as ROCA which was documented recently in 2017

> [ROCA: Vulnerable RSA generation (CVE-2017-15361)](https://crocs.fi.muni.cz/public/papers/rsa_ccs17)
- [Conference slides](https://crocs.fi.muni.cz/_media/public/papers/ccs-nemec-handout.pdf)
- [Paper on the vulnerability](https://crocs.fi.muni.cz/_media/public/papers/nemec_roca_ccs17_preprint.pdf)

#### Testing for ROCA vulnerability

[We can test using this tool](https://github.com/crocs-muni/roca).

    $ pip install roca-detect
    $ roca-detect --key-fmt-dec n.txt 

    2018-02-14 11:51:08 [19390] WARNING Fingerprint found in modulus n.txt idx 0 
    {"type": "mod-dec", "fname": "n.txt", "idx": 0, "aux": null, "n": "0xe247ca8b6bd40a8d1dd17dc4f62f4d85a4aa0fa068423fb2d1b01e8d11e0ac18a6453b9a94241ba409166e8bb188e4616197b21b352d72f7c7ca020731785ef9", "marked": true, "time_years": 0.00013349807611760526, "price_aws_c4": 0.05851220676234639}
    2018-02-14 11:51:08 [19390] INFO ### SUMMARY ####################
    2018-02-14 11:51:08 [19390] INFO Records tested: 2
    2018-02-14 11:51:08 [19390] INFO .. PEM certs: . . . 0
    2018-02-14 11:51:08 [19390] INFO .. DER certs: . . . 0
    2018-02-14 11:51:08 [19390] INFO .. RSA key files: . 0
    2018-02-14 11:51:08 [19390] INFO .. PGP master keys: 0
    2018-02-14 11:51:08 [19390] INFO .. PGP total keys:  0
    2018-02-14 11:51:08 [19390] INFO .. SSH keys:  . . . 0
    2018-02-14 11:51:08 [19390] INFO .. APK keys:  . . . 0
    2018-02-14 11:51:08 [19390] INFO .. JSON keys: . . . 0
    2018-02-14 11:51:08 [19390] INFO .. LDIFF certs: . . 0
    2018-02-14 11:51:08 [19390] INFO .. JKS certs: . . . 0
    2018-02-14 11:51:08 [19390] INFO .. PKCS7: . . . . . 0
    2018-02-14 11:51:08 [19390] INFO Fingerprinted keys found: 1
    2018-02-14 11:51:08 [19390] INFO WARNING: Potential vulnerability
    2018-02-14 11:51:08 [19390] INFO ################################

From the output, we can see that the public key `n` has a size of 512-bits.

---

#### Format of RSA primes

> Reference:
- [ROCA vulnerability - Wikipedia](https://en.wikipedia.org/wiki/ROCA_vulnerability)
- [roca-crack - Github](https://github.com/AntonKueltz/roca-crack)

Structure of primes

    << Section 2.1 of the paper >>

    All RSA primes (as well as the moduli) generated by the RSALib have the following form:

        p = k * M + (65537^a mod M)

    where M is the product of the first n successive primes (2, 3, 5, 7, 11, 13,...),
    and n is a constant that only depends on the desired key size.

    The value n = 39 (i.e., M = 2 ∗ 3 ∗ ... ∗ 167) is used to generate primes for an
    RSA key with a key size within the [512, 960] interval

With the key size of 512 bits, we will be using the first 39 successive primes

    $ python3
    >>> primes = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53,
            59, 61, 67, 71, 73, 79, 83, 89, 97, 101, 103, 107, 109, 113,
            127, 131, 137, 139, 149, 151, 157, 163, 167]
    >>> from operator import mul
    >>> from functools import reduce
    >>> M = reduce(mul, primes)
    >>> M
    962947420735983927056946215901134429196419130606213075415963491270

---

#### Bruteforcing for `a`

Reference:
 - [How does the ROCA attack work? - StackExchange](https://crypto.stackexchange.com/questions/53906/how-does-the-roca-attack-work)


Most ROCA scripts use sagemath:

    $ brew cask install sage


Scripts:
 - https://github.com/mimoo/RSA-and-LLL-attacks/blob/master/coppersmith.sage
 - https://gist.github.com/FelixMartel/88e24902281eab88b5d4c5005eb1903a

I adapted the scripts into `roca-rsa_returns.sage`...

According to the paper, we need to bruteforce in the interval of [`c' / 2`, `(c' + order(M')) / 2`]

Running my script, it gives me the following interval:

    Trying a from 4572525320741 to 202873246433206432114914

---

***This is too time-consuming and I did not have the hardware to solve this challenge.***

There are scripts to solve ROCA but they skipped the bruteforcing portion by having partial knowledge of `p`:
- [2017.11.05: Reconstructing ROCA](https://blog.cr.yp.to/20171105-infineon.html)


## Flag
`?`